{"version":3,"sources":["utils/index.ts","Kuwahara-Filter/shader/index.js","Kuwahara-Filter/index.tsx","Kuwahara-Filter/hooks/useFilter.ts","App.tsx","serviceWorker.ts","index.tsx"],"names":["convertBlobToBase64","blob","Promise","resolve","reject","reader","FileReader","onerror","onload","result","readAsDataURL","getAspectRatioOfBase64","base64","image","Image","naturalWidth","naturalHeight","src","download","filename","anchor","document","createElement","href","replace","body","appendChild","click","removeChild","kuwahara","initialCanvasSize","width","height","Container","styled","div","_templateObject","InputSection","_templateObject2","DownloadSection","_templateObject3","App","stageRef","useRef","_useState","useState","_useState2","Object","slicedToArray","canvasSize","setCanvasSize","_useState3","_useState4","setBase64","KuwaharaFilter","_ref","uniforms","useMemo","resolution","type","value","PIXI","useFilter","objectSpread","handleFiles","useCallback","asyncToGenerator","regenerator_default","a","mark","_callee","event","files","_base64","aspectRatio","wrap","_context","prev","next","Array","prototype","slice","call","target","sent","t0","alert","message","stop","this","_x","apply","arguments","handleDownload","stageElement","current","app","renderer","plugins","extract","stage","react_default","Fragment","accept","onChange","react_pixi_module","assign","ref","filters","onClick","createGlobalStyle","App_templateObject","reset","Title","h1","App_templateObject2","Boolean","window","location","hostname","match","ReactDOM","render","getElementById","navigator","serviceWorker","ready","then","registration","unregister"],"mappings":"gQAAaA,EAAsB,SAACC,GAAD,OACjC,IAAIC,QAAQ,SAACC,EAASC,GACpB,IAAMC,EAAS,IAAIC,WACnBD,EAAOE,QAAUH,EACjBC,EAAOG,OAAS,WACVH,EAAOI,OACTN,EAAQE,EAAOI,QAEfL,EAAO,yBAGXC,EAAOK,cAAcT,MAmBZU,EAAyB,SAACC,GAAD,OACpC,IAAIV,QAAQ,SAAAC,GACV,IAAMU,EAAQ,IAAIC,MAClBD,EAAML,OAAS,WACbL,EAAQU,EAAME,aAAeF,EAAMG,gBAErCH,EAAMI,IAAML,KAGHM,EAAW,SAACN,EAAgBO,GACvC,IAAMC,EAASC,SAASC,cAAc,KACtCF,EAAOF,SAAWC,EAClBC,EAAOG,KAAOX,EAAOY,QAAQ,qBAAsB,iCACnDH,SAASI,KAAKC,YAAYN,GAC1BA,EAAOO,QACPN,SAASI,KAAKG,YAAYR,WCgBfS,EAAQ,m8ECvDrB,IAAMC,EAAoB,CAAEC,MAAO,IAAKC,OAAQ,KAE1CC,EAAYC,UAAOC,IAAVC,KAITC,EAAeH,UAAOC,IAAVG,KAIZC,EAAkBL,UAAOC,IAAVK,KAIN,SAASC,IACtB,IAAMC,EAAWC,iBAAoD,MADzCC,EAEQC,mBAASf,GAFjBgB,EAAAC,OAAAC,EAAA,EAAAD,CAAAH,EAAA,GAErBK,EAFqBH,EAAA,GAETI,EAFSJ,EAAA,GAAAK,EAGAN,mBAAwB,MAHxBO,EAAAL,OAAAC,EAAA,EAAAD,CAAAI,EAAA,GAGrBvC,EAHqBwC,EAAA,GAGbC,EAHaD,EAAA,GAIpBE,ECfK,SAAAC,GAA6C,IAAxBxB,EAAwBwB,EAAxBxB,MAAOC,EAAiBuB,EAAjBvB,OACnCwB,EAAWC,kBACf,iBAAO,CACLC,WAAY,CACVC,KAAM,KACNC,MAAO,CAAC7B,EAAOC,MAGnB,CAACD,EAAOC,IAKV,MAAO,CACLsB,eAHqBG,kBAAQ,kBAAM,IAAII,SAAY,GAAIhC,EAAU2B,IAAW,CAACA,KDIpDM,CAAUf,OAAAgB,EAAA,EAAAhB,CAAA,GAAKE,IAAlCK,eAEFU,EAAcC,sBAAW,eAAAV,EAAAR,OAAAmB,EAAA,EAAAnB,CAAAoB,EAAAC,EAAAC,KAAC,SAAAC,EAAOC,GAAP,IAAAC,EAAAC,EAAAC,EAAA,OAAAP,EAAAC,EAAAO,KAAA,SAAAC,GAAA,cAAAA,EAAAC,KAAAD,EAAAE,MAAA,cACxBN,EAAQO,MAAMC,UAAUC,MAAMC,KAAKX,EAAMY,OAAOX,OADxBI,EAAAC,KAAA,EAG5B3B,EAAcpB,GAHc8C,EAAAE,KAAA,EAIN9E,EAAoBwE,EAAM,IAJpB,cAItBC,EAJsBG,EAAAQ,KAK5B/B,EAAUoB,GALkBG,EAAAE,KAAA,EAMFnE,EAAuB8D,GANrB,OAMtBC,EANsBE,EAAAQ,KAO5BlC,EAAc,SAAA2B,GAAI,OAAA9B,OAAAgB,EAAA,EAAAhB,CAAA,GAAU8B,EAAV,CAAgB9C,MAAO8C,EAAK9C,MAAQ2C,MAP1BE,EAAAE,KAAA,iBAAAF,EAAAC,KAAA,GAAAD,EAAAS,GAAAT,EAAA,SAS5BU,MAAMV,EAAAS,GAAIE,SATkB,yBAAAX,EAAAY,SAAAlB,EAAAmB,KAAA,aAAD,gBAAAC,GAAA,OAAAnC,EAAAoC,MAAAF,KAAAG,YAAA,GAW5B,IAEGC,EAAiB5B,sBAAY,WACjC,IAAM6B,EAAepD,EAASqD,QAC9B,GAAKD,EAAL,CAIA,IAAME,EAAMF,EAAaE,IACnBvB,EAAUuB,EAAIC,SAASC,QAAQC,QAAQvF,OAAOoF,EAAII,OACxDlF,EAASuD,EAAS,kBALhBa,MAAM,oBAMP,IAEH,OACEe,EAAAjC,EAAA9C,cAAA+E,EAAAjC,EAAAkC,SAAA,KACED,EAAAjC,EAAA9C,cAACW,EAAD,KACEoE,EAAAjC,EAAA9C,cAACe,EAAD,KACEgE,EAAAjC,EAAA9C,cAAA,SAAOqC,KAAK,OAAO4C,OAAO,UAAUC,SAAUxC,KAEhDqC,EAAAjC,EAAA9C,cAACmF,EAAA,MAAD1D,OAAA2D,OAAA,CAAOC,IAAKjE,GAAcO,GACvBrC,GAAUyF,EAAAjC,EAAA9C,cAACmF,EAAA,OAAD1D,OAAA2D,OAAA,CAAQ7F,MAAOD,EAAQgG,QAAS,CAACtD,IAAqBL,KAElErC,GACCyF,EAAAjC,EAAA9C,cAACiB,EAAD,KACE8D,EAAAjC,EAAA9C,cAAA,UAAQuF,QAAShB,GAAjB,8QExDQiB,4BAAHC,IACbC,KADJ,IAIMC,EAAQ/E,UAAOgF,GAAVC,KCGSC,QACW,cAA7BC,OAAOC,SAASC,UAEe,UAA7BF,OAAOC,SAASC,UAEhBF,OAAOC,SAASC,SAASC,MAAM,2DCZnCC,IAASC,OAAOrB,EAAAjC,EAAA9C,cFYD,WACb,OACE+E,EAAAjC,EAAA9C,cAAA+E,EAAAjC,EAAAkC,SAAA,KACED,EAAAjC,EAAA9C,cAAC2F,EAAD,wBACAZ,EAAAjC,EAAA9C,cAACmB,EAAD,QEhBU,MAASpB,SAASsG,eAAe,SD0H3C,kBAAmBC,WACrBA,UAAUC,cAAcC,MAAMC,KAAK,SAAAC,GACjCA,EAAaC","file":"static/js/main.94fe5cb2.chunk.js","sourcesContent":["export const convertBlobToBase64 = (blob: Blob): Promise<any> =>\n  new Promise((resolve, reject) => {\n    const reader = new FileReader()\n    reader.onerror = reject\n    reader.onload = () => {\n      if (reader.result) {\n        resolve(reader.result)\n      } else {\n        reject('File does not exist.')\n      }\n    }\n    reader.readAsDataURL(blob)\n  })\n\nexport const convertBase64ToBlob = (base64: string, mimeCtype: string) => {\n  const bom = new Uint8Array([0xef, 0xbb, 0xbf])\n  const bin = atob(base64.replace(/^.*,/, ''))\n  const buffer = new Uint8Array(bin.length)\n  for (let i = 0; i < bin.length; i++) {\n    buffer[i] = bin.charCodeAt(i)\n  }\n  try {\n    return new Blob([bom, buffer.buffer], {\n      type: mimeCtype,\n    })\n  } catch (e) {\n    console.log(e.message)\n  }\n}\n\nexport const getAspectRatioOfBase64 = (base64: string): Promise<number> =>\n  new Promise(resolve => {\n    const image = new Image()\n    image.onload = () => {\n      resolve(image.naturalWidth / image.naturalHeight)\n    }\n    image.src = base64\n  })\n\nexport const download = (base64: string, filename: string) => {\n  const anchor = document.createElement('a')\n  anchor.download = filename\n  anchor.href = base64.replace(/^data:image\\/[^;]+/, 'data:application/octet-stream')\n  document.body.appendChild(anchor)\n  anchor.click()\n  document.body.removeChild(anchor)\n}\n","export const bilateral = `\n  #ifdef GL_ES\n  precision mediump float;\n  precision mediump int;\n  #endif\n\n  #define SIGMA 5.0\n  #define BSIGMA 0.6\n  #define MSIZE 2\n\n  varying vec2 vTextureCoord;\n  uniform sampler2D uSampler;\n  uniform vec2 resolution;\n\n  float normpdf(in float x, in float sigma)\n  {\n    return 0.39894*exp(-0.5*x*x/(sigma*sigma))/sigma;\n  }\n\n  float normpdf3(in vec3 v, in float sigma)\n  {\n    return 0.39894*exp(-0.5*dot(v,v)/(sigma*sigma))/sigma;\n  }\n\n  void main(void)\n  {\n    vec3 c = texture2D( uSampler, vTextureCoord).rgb;\n\n    //declare stuff\n    const int kSize = (MSIZE-1)/2;\n    float kernel[MSIZE];\n    vec3 final_color = vec3(0.0);\n\n    //create the 1-D kernel\n    float Z = 0.0;\n    for (int j = 0; j <= kSize; ++j)\n    {\n      kernel[kSize+j] = kernel[kSize-j] = normpdf(float(j), SIGMA);\n    }\n\n    vec3 cc;\n    float factor;\n    float bZ = 1.0/normpdf(0.0, BSIGMA);\n\n    //read out the texels\n    for (int i=-kSize; i <= kSize; ++i)\n    {\n      for (int j=-kSize; j <= kSize; ++j)\n      {\n        cc = texture2D(uSampler, vec2(0.0, 0.0) + ( gl_FragCoord.xy + vec2(float(i),float(j)) ) / resolution.xy ).rgb;\n        factor = normpdf3(cc-c, BSIGMA)*bZ*kernel[kSize+j]*kernel[kSize+i];\n        Z += factor;\n        final_color += factor*cc;\n      }\n    }\n\n    gl_FragColor = vec4(final_color/Z, 1.0);\n  }\n`\n\n// Portiert von https://github.com/MzHub/gpuakf/blob/master/glsl/kuwahara.glsl\nexport const kuwahara = `\n  #ifdef GL_ES\n  precision mediump float;\n  precision mediump int;\n  #endif\n\n  varying vec2 vTextureCoord;\n  uniform sampler2D uSampler;\n  uniform vec2 resolution;\n\n  #define RADIUS 3\n\n  void main (void) {\n\n    // Bildkoordinaten des aktuellen Pixels -> (u,v) von 0 .. 1\n    vec2 src_size = vec2(resolution.x, resolution.y);\n    vec2 uv = vTextureCoord;\n\n    // Anzahl der Pixel einer Region\n    float n = float((RADIUS + 1) * (RADIUS + 1));\n\n    // Summen und Summenquadrate der Regionen (in Burger: (17.4 S_1,k, 17.5 S_2,k)\n    // Zu beachten: Jeweils Vektoren mit 3 Elementen für die einzelnen Farbkanäle RGB\n    vec3 m[4];\n    vec3 s[4];\n    for (int k = 0; k < 4; ++k) {\n      m[k] = vec3(0.0);\n      s[k] = vec3(0.0);\n    }\n\n    for (int t = -RADIUS; t <= 0; ++t) {\n      for (int i = -RADIUS; i <= 0; ++i) {\n        vec3 c = texture2D(uSampler, uv + vec2(i,t) / src_size).rgb;\n        m[0] += c;\n        s[0] += c * c;\n      }\n    }\n\n    for (int j = -RADIUS; j <= 0; ++j) {\n      for (int i = 0; i <= RADIUS; ++i) {\n        vec3 c = texture2D(uSampler, uv + vec2(i,j) / src_size).rgb;\n        m[1] += c;\n        s[1] += c * c;\n      }\n    }\n\n    for (int j = 0; j <= RADIUS; ++j) {\n      for (int i = 0; i <= RADIUS; ++i) {\n        vec3 c = texture2D(uSampler, uv + vec2(i,j) / src_size).rgb;\n        m[2] += c;\n        s[2] += c * c;\n      }\n    }\n\n    for (int j = 0; j <= RADIUS; ++j) {\n      for (int i = -RADIUS; i <= 0; ++i) {\n        vec3 c = texture2D(uSampler, uv + vec2(i,j) / src_size).rgb;\n        m[3] += c;\n        s[3] += c * c;\n      }\n    }\n\n    // Region mit der kleinsten Varianz finden und deren Mittelwert als neuen Pixelwert nutzen\n\n    float min_sigma2 = 100.0;\n    for (int k = 0; k < 4; ++k) {\n\n      // Tatsächliche Mittelwerte und Varianzen der Regionen berechnen\n      // Analog zu (17.3) in Burger\n      m[k] /= n;\n      s[k] = abs(s[k] / n - m[k] * m[k]);\n\n      // \"Totale Varianz\"\n      float sigma2 = s[k].r + s[k].g + s[k].b;\n\n      if (sigma2 < min_sigma2) {\n        min_sigma2 = sigma2;\n        // Neuen Pixelwert setzen\n        gl_FragColor = vec4(m[k], 1.0);\n      }\n    }\n  }\n`","import { Sprite, Stage } from '@inlet/react-pixi'\nimport React, { ChangeEvent, useCallback, useRef, useState } from 'react'\nimport styled from 'styled-components'\nimport { convertBlobToBase64, download, getAspectRatioOfBase64 } from '../utils'\nimport useFilter from './hooks/useFilter'\n\nconst initialCanvasSize = { width: 500, height: 500 }\n\nconst Container = styled.div`\n  text-align: center;\n`\n\nconst InputSection = styled.div`\n  margin-bottom: 10px;\n`\n\nconst DownloadSection = styled.div`\n  margin-top: 10px;\n`\n\nexport default function App() {\n  const stageRef = useRef<ReactPixi.Stage & { app: PIXI.Application }>(null)\n  const [canvasSize, setCanvasSize] = useState(initialCanvasSize)\n  const [base64, setBase64] = useState<string | null>(null)\n  const { KuwaharaFilter } = useFilter({ ...canvasSize })\n\n  const handleFiles = useCallback(async (event: ChangeEvent<HTMLInputElement>) => {\n    const files = Array.prototype.slice.call(event.target.files)\n    try {\n      setCanvasSize(initialCanvasSize)\n      const _base64 = await convertBlobToBase64(files[0])\n      setBase64(_base64)\n      const aspectRatio = await getAspectRatioOfBase64(_base64)\n      setCanvasSize(prev => ({ ...prev, width: prev.width * aspectRatio }))\n    } catch (err) {\n      alert(err.message)\n    }\n  }, [])\n\n  const handleDownload = useCallback(() => {\n    const stageElement = stageRef.current\n    if (!stageElement) {\n      alert('Download failed')\n      return\n    }\n    const app = stageElement.app\n    const _base64 = app.renderer.plugins.extract.base64(app.stage)\n    download(_base64, 'image.jpg')\n  }, [])\n\n  return (\n    <>\n      <Container>\n        <InputSection>\n          <input type=\"file\" accept=\"image/*\" onChange={handleFiles} />\n        </InputSection>\n        <Stage ref={stageRef} {...canvasSize}>\n          {base64 && <Sprite image={base64} filters={[KuwaharaFilter]} {...canvasSize} />}\n        </Stage>\n        {base64 && (\n          <DownloadSection>\n            <button onClick={handleDownload}>Download</button>\n          </DownloadSection>\n        )}\n      </Container>\n    </>\n  )\n}\n","import * as PIXI from 'pixi.js'\nimport { useCallback, useMemo } from 'react'\nimport { kuwahara } from '../shader'\n\ninterface Props {\n  width: number\n  height: number\n}\n\nexport default function useFilter({ width, height }: Props) {\n  const uniforms = useMemo(\n    () => ({\n      resolution: {\n        type: 'v2',\n        value: [width, height],\n      },\n    }),\n    [width, height]\n  )\n\n  const KuwaharaFilter = useMemo(() => new PIXI.Filter('', kuwahara, uniforms), [uniforms])\n\n  return {\n    KuwaharaFilter,\n  }\n}\n","import React from 'react'\nimport styled, { createGlobalStyle } from 'styled-components'\nimport reset from 'styled-reset'\nimport KuwaharaFilter from './Kuwahara-Filter'\n\nconst GlobalStyle = createGlobalStyle`\n  ${reset}\n`\n\nconst Title = styled.h1`\n  font-size: 36px;\n  font-weight: bold;\n  text-align: center;\n  line-height: 1.5;\n  padding: 24px 0;\n`\n\nexport default function App() {\n  return (\n    <>\n      <Title>Kuwahara Filter</Title>\n      <KuwaharaFilter />\n    </>\n  )\n}\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read http://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.1/8 is considered localhost for IPv4.\n    window.location.hostname.match(/^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/)\n)\n\ninterface Config {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void\n  onUpdate?: (registration: ServiceWorkerRegistration) => void\n}\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL((process as { env: { [key: string]: string } }).env.PUBLIC_URL, window.location.href)\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config)\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit http://bit.ly/CRA-PWA'\n          )\n        })\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config)\n      }\n    })\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing\n        if (installingWorker === null) {\n          return\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See http://bit.ly/CRA-PWA.'\n              )\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration)\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.')\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration)\n              }\n            }\n          }\n        }\n      }\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error)\n    })\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl)\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type')\n      if (response.status === 404 || (contentType !== null && contentType.indexOf('javascript') === -1)) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload()\n          })\n        })\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config)\n      }\n    })\n    .catch(() => {\n      console.log('No internet connection found. App is running in offline mode.')\n    })\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready.then(registration => {\n      registration.unregister()\n    })\n  }\n}\n","import React from 'react'\nimport ReactDOM from 'react-dom'\nimport App from './App'\nimport * as serviceWorker from './serviceWorker'\n\nReactDOM.render(<App />, document.getElementById('root'))\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: http://bit.ly/CRA-PWA\nserviceWorker.unregister()\n"],"sourceRoot":""}